​ 作为 Web 开发人员，HTTP 缓存与我们关系至关紧密。本文我们渐进式的去了解 HTTP 缓存机制和相关请求头。

​ HTTP 缓存的意义就是复用资源，从而达到减少数据交换的时间，提升性能；也可以缓解服务器压力。常见的 HTTP 缓存只能存储 GET 响应，对于其他类型的响应则无能为力。缓存的关键主要包括`request Method`和请求`URI`。所有的资源只要`Method`和路径相同就一直使用缓存吗？当然不是，服务器的资源是可能会更改的。

​ 浏览器和服务器之间根据`Header`来对缓存进行交流，`Cache-Control`头字段用于实现缓存机制。

#### 设定资源过期时间

​ 首先我们能想到的方法就是使缓存的资源有一个保鲜期，客户端每次请求该资源之前都会先看一下当前是否有缓存该资源，然后再查看该资源是否过期，只有过期后才会去重新请求服务器。

> **HTTP1.0**
>
> Expires 响应头包含日期/时间， 即在此时候之后，响应过期。这个时间因为是服务端返回的，所以是以服务端时间为准的。
>
> **HTTP1.1**
>
> Cache-Control: max-age = 100。 这里的 max-age 是距离请求发起的时间秒数，即资源缓存指定长度时间而不是像 Expires 在绝对时间后失效。
>
> 如果上述两个字段都存在，以 Cache-Control 为准。

​ 如果资源一直不变化，但是对客户端而言过期后资源就失效了，我们每隔一段时间还是会去请求服务器。如何优化这一点呢。

#### 校验资源修改时间

​ 根据刚才的描述，客户端知道资源过期后，会重新请求服务端，进行资源的下载更新，无论资源是否更新。自然我们会去想到对比文件更新时间。

> If-Modified-Since 请求头 服务器只在所请求的资源在给定的日期时间之后对内容进行过修改的情况下才会将资源返回
>
> Last-Modified 响应头 源头服务器认定的资源做出修改的日期及时间，只能精确到秒。
>
> 如果没有 Expires、max-age，该请求头还能够用于缓存时间计算，缓存寿命为`(Date - Last-Modified) / 10`，`Date`为响应头中的数据字段。
>
> 对于同一个请求，If-Modified-Since 就是上一次请求响应的 Last-Modified。

​ 第一次请求后，拿到`Last-Modified`响应头。第二次请求时，如果已经失效，请求服务器，同时带上请求头`If-Modified-Since`，值为上次请求响应头`Last-Modified`值。服务器校验资源修改时间。如果有更新的资源则返回更新的资源，状态码为`200`；如果服务器上资源时间不是更新的，则返回`304`，通知客户端使用缓存的资源。

#### 检验资源唯一标识

​ 上面我们提到`Last-Modified`只能精确到秒，而在一些场景中存在更为频繁的更新，通过修改时间来进行处理则不符合我们的需求了。资源有没有修改过还是要根据资源内容本身进行判断。
> ETag  响应头，资源的特定版本的标识符
>
> If-None-Match 请求头
> 
> 对于`GET`、`HEAD`方法来说，当验证后有相同标识符资源时，返回`304 Not Modified`；当没有资源匹配时，才返回相应资源，状态码为`200`。

​ 在第一次请求后，服务端返回相应的资源并带上资源的唯一标识符作为`ETag`。在保鲜期后，第二次请求服务器时，带上该资源唯一标识符放到请求头`If-None-Match`。此时如果请求头中也有`If-Modified-Since`时，则会忽略，只处理`If-None-Match`。服务端进行对比后，返回`304`或者`200`。

​ `ETag`是如何生成的呢？[MDN对此的描述](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/ETag)是这样的：
>没有明确指定生成ETag值的方法。 通常，使用内容的散列，最后修改时间戳的哈希值，或简单地使用版本号。 例如，MDN使用wiki内容的十六进制数字的哈希值。

#### Cache-Control
​ 大致说一下上面提到了多次的`Cache-Control`，这是`HTTP1.1`中新增的，用于实现缓存机制。除了上面提到的`max-age`，常见的还有

> Cache-Control: no-store 关闭缓存
> 
> Cache-Control:public, max-age=31536000 缓存静态资源，这个例子是想说多个指令是以逗号进行分割的。
> 
更多的关于`Cache-Control`内容，可见[MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control)
 